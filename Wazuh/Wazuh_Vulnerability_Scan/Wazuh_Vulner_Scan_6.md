# Querying the vulnerability database

Ta có thể tìm thấy vulnerability database ở ```/var/ossec/queue/vulnerabilities/cve.db``` trên Wazuh server và truy vấn nó sử dụng ```SQLite```. ```SQLite``` cung cấp 1 giao diện mà ta có thể tương tác với SQL databases

Thực hiện các bước sau để truy vấn vulnerability database sử dụng SQLite

1. Start ```SQLite``` và mở vulnerability database bằng lệnh

```sh
sqlite3 /var/ossec/queue/vulnerabilities/cve.db
```

2. Liệt kê các bảng có trong db

```sh
.tables
```

3. Lấy dữ liệu trong 1 bảng

```sh
SELECT * from <TABLE>;
```

## Use case: Tìm tất cả KB mà vá 1 CVE được chỉ định cho Windows endpoint

Trong ví dụ này, ta sẽ tìm hiểu cách để tìm kiếm Windows Knowledge Base (KB) cập nhật mà vá 1 lỗ hổng định trên Windows Endpoints từ vulnerability database. Ta có thể đạt được điều này với ```SQLite``` trên Wazuh server

1. Start ```SQLite``` và mở vulnerability database sử dụng lệnh sau 

```sh
sqlite3 /var/ossec/queue/vulnerabilities/cve.db
```

2. Chạy ```.mode line``` để thiết lập SQLite output format

3. Chạy lệnh sau để xem tất cả chi tiết của CVE được chọn và OS

```sh
SELECT * FROM msu WHERE cveid = "<CVE_ID>" AND PRODUCT LIKE "%<OS_IDENTIFIER>%";
```

Trong đó:
- ```<OS_IDENTIFIER>```: là 1 xâu từ tên OS. Nó hiển thị kết quả chỉ cho OS được chỉ định
- ```<CVE_ID>```: định danh của CVE

Ví dụ:

```sh
SELECT * FROM msu WHERE cveid = "CVE-2023-21524" AND PRODUCT LIKE "%Server 2022%";
```

Đầu ra sẽ là

```sh
CVEID = CVE-2023-21524
         PRODUCT = Windows Server 2022 (Server Core installation)
           PATCH = 5022291
           TITLE = Windows Local Security Authority (LSA) Elevation of Privilege Vulnerability
             URL = https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB5022291
         SUBTYPE = Security Update
RESTART_REQUIRED = Yes
      CHECK_TYPE = 1

           CVEID = CVE-2023-21524
         PRODUCT = Windows Server 2022
           PATCH = 5022291
           TITLE = Windows Local Security Authority (LSA) Elevation of Privilege Vulnerability
             URL = https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB5022291
         SUBTYPE = Security Update
RESTART_REQUIRED = Yes
      CHECK_TYPE = 1
```

4. Chạy lệnh bên dưới để liệt kê tất cả KBs mà được thay thế bởi ```KB22291```. Đây sẽ là danh sách các patch mà không cần phải cafid dặt nữa nếu đã cài đặt ```KB5022291```

```sh
SELECT patch FROM msu_supersedence WHERE super = "5022291";
```

Đầu ra có dạng

```sh
PATCH = 5010796

PATCH = 5022291

PATCH = 5022553

PATCH = 5021656

PATCH = 5021249

PATCH = 5020436

PATCH = 5020032
...
```

5. Chạy lệnh sau để lấy 1 danh sách tất cả các patch mà thay thế ```KB5022291```. Đây là danh sách bao gồm tất cả các patch mà giải quyết các lỗ hổng tương tự ```KB5022291``` nếu được cài đặt

```sh
SELECT super FROM msu_supersedence WHERE patch = "5022291";
```

Đầu ra có dạng

```sh
SUPER = 5022291
SUPER = 5022842
SUPER = 5023705
SUPER = 5025230
SUPER = 5026370
```