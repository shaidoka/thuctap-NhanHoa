# VirusTotal integration

Wazuh phát hiện các tệp khả nghi thông qua 1 tích hợp với VirusTotal - 1 nền tảng mạnh mẽ tổng hợp từ nhiều sản phẩm antivirus và là 1 online scanning engine. Kết hợp công cụ này với FIM module cung cấp 1 cách thức hiệu quả để phân tích các tệp được giám sát cho việc tìm kiếm mối nguy hại.

## Về VirusTotal

VirusTotal là 1 dịch vụ online mà phân tích các tệp và URLs để phát hiện viruses, worms, trojans, và các nội dung đọc hại khác sử dụng antivirus engines và website sanners.

VirusTotal là 1 dịch vụ free với rất nhiều tính năng tiện lợi. Chúng ta sẽ tận dụng những thứ sau cho mục đích của mình:
- VirusTotal lưu trữ tất cả các phân tích mà nó thực hiện, cho phép người dùng tìm kiếm mã băm của tệp. Bằng cách gửi mã băm đến VirusTotal engine, ta có thể biết nếu VirusTotal đã từng quét file đó hay chưa, và ta có thể phân tích báo cáo của nó
- Virus cũng cung cấp API mà cho phép truy nhập đến thông tin khởi tạo bởi VirusTotal mà không cần thiết phải khai thác giao diện website. API này sẽ được đề cập đến ở phần sau

## Điều khoản dịch vụ

Điều khoản dịch vụ của VirusTotal chỉ định 2 cách thức mà người dùng có thể sử dụng VirusTotal API:

### Public API

Phương thức này sử dụng free API với nhiều tính năng của VirusTotal. Tuy nhiên, nó có giới hạn, như là:
- Giới hạn request rate (500 requests/day và 4 requests/min)
- Độ ưu tiên thấp bởi VirusTotal engine

### Private API (Premium API)

VirusTotal cũng cung cấp 1 premium Private API nơi mà request rates tùy thuộc vào từng loại gói. Ngoài ra thì các truy vấn đến API này cũng được ưu tiên bởi VirusTotal engine.

## Cách thức hoạt động

Cách tích hợp này sử dụng VirusTotal để phát hiện nội dung độc hại bên trong các tệp và đường dẫn được giám sát bởi FIM module của Wazuh. Nó hoạt động theo cách như sau:
- Wazuh FIM giám sát các file thêm mới, sửa đổi, hoặc xóa bỏ trên đường dẫn được cấu hình. Module này có mã băm của các file này và kích hoạt cảnh báo nếu chúng có thay đổi
- Nếu được kích hoạt, Wazuh trigger VirusTotal integration khi 1 FIM alert xảy ra. Từ alert này, VT integration trích xuất trường băm của file
- VT integration sau đó tạo 1 truy vấn HTTP POST đến VirusTotal database sử dụng VirusTotal API. Lệnh gọi này gửi mã băm của file đã trích xuất và so sánh nó với thông tin trong VirusTotal database
- VT integration nhận phản hồi JSON, là kết quả của truy vấn. Phản hồi này sẽ kích hoạt 1 trong số các cảnh báo sau của Wazuh:
   - Error: Check credentials
   - Error: Public API request rate limit reached
   - Alert: No records in VirusTotal database
   - Alert: No positives found
   - Alert: X engines detected this file. X is the number of antivirus engines

Wazuh ghi log cảnh báo được kích hoạt trong file ```/var/ossec/logs/integration.log``` và lưu trữ nó trong file ```/var/ossec/logs/alerts.log```

## Use case: Scanning a file

### Getting started

Trước khi bắt đầu, hãy khai báo API key của ta đã, thêm đoạn cấu hình sau vào file ```/var/ossec/etc/ossec.conf``` trên Wazuh server

```sh
<integration>
  <name>virustotal</name>
  <api_key>API_KEY</api_key> <!-- Replace with your VirusTotal API key -->
  <group>syscheck</group>
  <alert_format>json</alert_format>
</integration>
```

Sau đó restart wazuh manager

```sh
systemctl restart wazuh-manager
```

### Sử dụng FIM để giám sát 1 directory

Thêm 1 thẻ syscheck vào file cấu hình, ta có thể cấu hình tùy chọn này ở wazuh server hay agent đều được, và đều nằm ở file ```/var/ossec/etc/ossec.conf```. Ví dụ

```sh
<syscheck>
  <directories check_all="yes" realtime="yes">/media/user/software</directories>
</syscheck>
```

Restart

```sh
systemctl restart wazuh-manager
```

Sau khi khởi động lại, FIM áp dụng cấu hình mới và giám sát đường dẫn ta chỉ định ở thực gian thực. Khi FIM phát hiện ra thay đổi, Wazuh khởi tạo 1 cảnh báo dạng

```sh

   "timestamp":"2022-11-17T19:17:42.694+0200",
   "rule":{
      "level":5,
      "description":"File added to the system.",
      "id":"554",
      "firedtimes":2,
      "mail":false,
      "groups":[
         "ossec",
         "syscheck",
         "syscheck_entry_added",
         "syscheck_file"
      ],
      "pci_dss":[
         "11.5"
      ],
      "gpg13":[
         "4.11"
      ],
      "gdpr":[
         "II_5.1.f"
      ],
      "hipaa":[
         "164.312.c.1",
         "164.312.c.2"
      ],
      "nist_800_53":[
         "SI.7"
      ],
      "tsc":[
         "PI1.4",
         "PI1.5",
         "CC6.1",
         "CC6.8",
         "CC7.2",
         "CC7.3"
      ]
   },
   "agent":{
      "id":"010",
      "name":"Ubuntu",
      "ip":"10.0.2.15"
   },
   "manager":{
      "name":"localhost.localdomain"
   },
   "id":"1668705462.50453",
   "full_log":"File '/media/user/software/suspicious-file.exe' added\nMode: realtime\n",
   "syscheck":{
      "path":"/media/user/software/suspicious-file.exe",
      "mode":"realtime",
      "size_after":"0",
      "perm_after":"rw-r--r--",
      "uid_after":"0",
      "gid_after":"0",
      "md5_after":"d41d8cd98f00b204e9800998ecf8427e",
      "sha1_after":"da39a3ee5e6b4b0d3255bfef95601890afd80709",
      "sha256_after":"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
      "uname_after":"root",
      "gname_after":"root",
      "mtime_after":"2022-11-17T19:17:42",
      "inode_after":1704505,
      "event":"added"
   },
   "decoder":{
      "name":"syscheck_new_entry"
   },
   "location":"syscheck"
}
```

Từ cảnh báo này, integrator module trích xuất trường băm, và gửi truy vấn đến VirusTotal để so sánh